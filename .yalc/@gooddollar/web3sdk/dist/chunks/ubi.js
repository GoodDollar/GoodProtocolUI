import{H as t,I as n,a2 as e,t as r,a4 as o,x as a,a1 as u,S as s,k as c,a5 as i,_ as m,a6 as l,Y as f,N as d}from"./tokens.js";import{b as A,a as h}from"./tokenLists.js";import{d as p,a as y,g as b}from"./converter.js";import{c as v,e as I}from"./compoundPrice.js";import{b as w,g as D,a as G,U as g,d as S,I as $}from"./errors.js";import{d as E,b as F,a as U}from"./debug.js";import{Z as R}from"./misc.js";import{e as T,i as j,u as x}from"./UBISchemeContract.js";import{p as k}from"./prepareValues.js";import{c as q}from"./prices.js";import{v as C,g as O,c as H}from"./calculateExitContribution.js";import{c as B}from"./FuseUniswapContract.js";import{t as P}from"./tokenBalance.js";import{a as X}from"./StakersDistributionContract.js";var L=0;function M(o,a,u){return t(this,void 0,void 0,(function(){var t,s,c,i,m,l,f,d;return n(this,(function(n){switch(n.label){case 0:if("cDAI"!==a.currency.symbol)throw new w(a.currency.symbol);return[4,D(o)];case 1:return t=n.sent(),[4,X(o,t)];case 2:return s=n.sent(),[4,A(t,"G$")];case 3:return c=n.sent(),i=++L,U("cDAI to G$ - ".concat(i)),m=a.multiply(a.decimalScale).toFixed(0),[4,s.methods.buyReturn(r[t].address,m).call()];case 4:return l=n.sent(),f=e.fromRawAmount(c,l.toString()),E("G$",f.toSignificant(6)),d=f.subtract(f.multiply(u)),E("G$ min",d.toSignificant(6)),F("cDAI to G$ - ".concat(i)),L--,[2,{amount:f,minAmount:d}]}}))}))}function N(o,a){return t(this,void 0,void 0,(function(){var t,u,s,c;return n(this,(function(n){switch(n.label){case 0:if("DAI"!==a.currency.symbol)throw new w(a.currency.symbol);return[4,D(o)];case 1:return t=n.sent(),U("DAI to cDAI"),[4,v(o,t)];case 2:return u=n.sent(),E("cDAI ratio",u.toSignificant(6)),s=a.divide(u).divide(1e10),c=e.fromFractionalAmount(r[t],s.numerator,s.denominator),E("cDAI",c.toSignificant(6)),F("DAI to cDAI"),[2,c]}}))}))}function W(r,o){return t(this,void 0,void 0,(function(){var t,a,u,s,c;return n(this,(function(n){switch(n.label){case 0:if("cDAI"!==o.currency.symbol)throw new w(o.currency.symbol);return[4,D(r)];case 1:return t=n.sent(),[4,A(t,"DAI")];case 2:return a=n.sent(),U("cDAI to DAI"),[4,v(r,t)];case 3:return u=n.sent(),E("cDAI ratio",u.toSignificant(6)),s=o.multiply(u).multiply(1e10),c=e.fromFractionalAmount(a,s.numerator,s.denominator),E("cDAI",c.toSignificant(6)),F("cDAI to DAI"),[2,c]}}))}))}function V(o,a,u){return t(this,void 0,void 0,(function(){var t,s,c,i,m,l;return n(this,(function(n){switch(n.label){case 0:if("G$"!==a.currency.symbol)throw new w(a.currency.symbol);return[4,D(o)];case 1:return t=n.sent(),[4,X(o,t)];case 2:return s=n.sent(),U("G$ to cDAI"),c=a.multiply(a.decimalScale).toFixed(0),[4,s.methods.sellReturn(r[t].address,c).call()];case 3:return i=n.sent(),m=e.fromRawAmount(r[t],i.toString()),E("cDAI",m.toSignificant(6)),l=m.subtract(m.multiply(u)),E("cDAI min",l.toSignificant(6)),F("G$ to cDAI"),[2,{amount:m,minAmount:l}]}}))}))}function Y(e,r,o){return t(this,void 0,void 0,(function(){var t,a,u,s,c;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),[4,A(t,"DAI")];case 2:return a=n.sent(),U("".concat(r.currency.symbol," to DAI")),[4,I(r,a,{chainId:t})];case 3:return(u=n.sent())?(s=u.outputAmount,E("DAI",s.toSignificant(6)),c=u.minimumAmountOut(o),E("DAI min",c.toSignificant(6)),F("".concat(r.currency.symbol," to DAI")),[2,{amount:s,minAmount:c,route:u.route.path,trade:u}]):(E("Trade",null),F("".concat(r.currency.symbol," to DAI")),[2,null])}}))}))}function Z(e,r,o){return t(this,void 0,void 0,(function(){var t,a;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),U("".concat(r.symbol," to DAI")),[4,C(r,o,{chainId:t})];case 2:return(a=n.sent())?(E(r.symbol,a.inputAmount.toSignificant(6)),F("".concat(r.symbol," to DAI")),[2,a.inputAmount]):(E("Trade",null),F("".concat(r.symbol," to DAI")),[2,null])}}))}))}function _(e,r,o){return t(this,void 0,void 0,(function(){var t,a,u,s,c;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),[4,A(t,"G$")];case 2:return a=n.sent(),U("".concat(r.currency.symbol," to G$")),[4,I(r,a,{chainId:t})];case 3:return(u=n.sent())?(s=u.outputAmount,E("G$",s.toSignificant(6)),c=u.minimumAmountOut(o),E("G$ min",c.toSignificant(6)),F("".concat(r.currency.symbol," to G$")),[2,{amount:s,minAmount:c,route:u.route.path,trade:u}]):(E("Trade",null),F("".concat(r.currency.symbol," to G$")),[2,null])}}))}))}function z(e,r,o){return t(this,void 0,void 0,(function(){var t,a;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),U("".concat(r.symbol," to G$")),[4,C(r,o,{chainId:t})];case 2:return(a=n.sent())?(E(r.symbol,a.inputAmount.toSignificant(6)),F("".concat(r.symbol," to G$")),[2,a.inputAmount]):(E("Trade",null),F("".concat(r.symbol," to G$")),[2,null])}}))}))}function J(t){var n=q(t);return E("Liquidity fee",n.toSignificant(6)),t.inputAmount.multiply(n)}function K(m,l,f,d){return void 0===d&&(d=.5),t(this,void 0,void 0,(function(){var t,h,b,v,I,w,S,$,T,j,x,k,q,C,H,B,P,X,L,W,V,Z;return n(this,(function(n){switch(n.label){case 0:return[4,D(m)];case 1:return t=n.sent(),console.log("CHAIN ID:",t),U("Get meta ".concat(f," ").concat(l," to G$")),[4,A(t,"G$")];case 2:if(h=n.sent(),console.log("getBuyMeta --\x3e",{G$:h}),!h)throw new g(t);return"ETH"!==l?[3,3]:(b=i.onChain(t),[3,6]);case 3:return"FUSE"!==l?[3,4]:(b=c,[3,6]);case 4:return[4,A(t,l)];case 5:b=n.sent(),n.label=6;case 6:if(!b)throw new G(l);return console.log("getBuyMeta --\x3e",{FROM:b}),[4,A(t,"DAI")];case 7:return v=n.sent(),w=null,S=null,k=null,q=e.fromRawAmount(b,"0"),C=new u(0),H=y(d),t!==s.FUSE?[3,9]:($=e.fromRawAmount(b,p(f,b.decimals)),console.log("amount --\x3e",{amount:f}),[4,_(m,$,H)]);case 8:return(X=n.sent())?(k=X.trade,x=X.route,q=J(X.trade),T=X.amount,j=X.minAmount,C=X.trade.priceImpact,console.log({trade:k,route:x,liquidityFee:q,outputAmount:T,minimumOutputAmount:j,priceImpact:C}),[3,23]):[2,null];case 9:return"G$"!==b.symbol?[3,10]:[2,null];case 10:return"cDAI"!==b.symbol?[3,12]:(B=r[t],x=[B],$=e.fromRawAmount(B,p(f,B.decimals)),w=e.fromRawAmount(v,0),I=S=$,[4,M(m,$,H)]);case 11:return W=n.sent(),T=W.amount,j=W.minAmount,[3,21];case 12:return"DAI"!==b.symbol?[3,16]:[4,A(t,"DAI")];case 13:return P=n.sent(),x=[P],$=e.fromRawAmount(P,p(f,P.decimals)),[4,N(m,w=$)];case 14:return I=S=n.sent(),[4,M(m,S,H)];case 15:return V=n.sent(),T=V.amount,j=V.minAmount,[3,21];case 16:return $=e.fromRawAmount(b,p(f,b.decimals)),[4,Y(m,$,H)];case 17:return(X=n.sent())?(w=X.minAmount,[4,N(m,w)]):[2,null];case 18:return S=n.sent(),[4,N(m,X.amount.add(X.amount.multiply(X.trade.priceImpact)))];case 19:return I=n.sent(),x=X.route,q=J(X.trade),[4,Promise.all([N(m,X.amount).then((function(t){return M(m,t,R)})),M(m,S,R)])];case 20:Z=a.apply(void 0,[n.sent(),2]),T=Z[0].amount,j=Z[1].minAmount,k=X.trade,n.label=21;case 21:return[4,O(m,t)];case 22:L=n.sent().cDAI,C=o(L,I,j),n.label=23;case 23:return F("Get meta ".concat(f," ").concat(l," to G$")),E("Route",x),[2,{inputAmount:$,outputAmount:T,minimumOutputAmount:j,DAIAmount:w,cDAIAmount:S,GDXAmount:T,priceImpact:C,slippageTolerance:H,liquidityFee:q,liquidityToken:b,route:x,trade:k}]}}))}))}function Q(r,o,a,u){return void 0===u&&(u=.5),t(this,void 0,void 0,(function(){var t,m,l,f,d,h,y;return n(this,(function(n){switch(n.label){case 0:return[4,D(r)];case 1:return t=n.sent(),U("Get meta ".concat(a," G$ to ").concat(o)),[4,A(t,"G$")];case 2:if(m=n.sent(),console.log("G$"),!m)throw new g(t);return"ETH"!==o?[3,3]:(l=i.onChain(t),[3,6]);case 3:return"FUSE"!==o?[3,4]:(l=c,[3,6]);case 4:return[4,A(t,o)];case 5:l=n.sent(),n.label=6;case 6:if(!l)throw new G(o);return f=e.fromRawAmount(m,p(a,m.decimals)),t!==s.FUSE?[3,8]:[4,z(r,l,f)];case 7:return d=n.sent(),[3,18];case 8:return"G$"!==l.symbol?[3,9]:(d=null,[3,18]);case 9:return"cDAI"!==l.symbol?[3,11]:[4,V(r,f,R)];case 10:return h=n.sent().amount,d=h,[3,18];case 11:return"DAI"!==l.symbol?[3,14]:[4,V(r,f,R)];case 12:return h=n.sent().amount,[4,W(r,h)];case 13:return d=n.sent(),[3,18];case 14:return[4,V(r,f,R)];case 15:return h=n.sent().amount,[4,W(r,h)];case 16:return y=n.sent(),[4,Z(r,l,y)];case 17:d=n.sent(),n.label=18;case 18:return F("Get meta ".concat(a," G$ to ").concat(o)),d?[2,K(r,o,d.toExact(),u)]:[2,null]}}))}))}function tt(e,r,o){return t(this,void 0,void 0,(function(){var t,u,c,i,d,A,h,p,y;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),[4,S(e)];case 2:return u=n.sent(),t!==s.FUSE?[3,3]:[2,B(e,r.trade,r.slippageTolerance,o)];case 3:return[4,T(e)];case 4:return c=n.sent(),i=k(r,"buy"),d=i.input,A=i.minReturn,h=i.minDai,p=void 0,p=r.trade&&r.trade.inputAmount.currency.isNative?m([l],a(r.route.slice(1).map((function(t){return t.address}))),!1):r.route.map((function(t){return t.address})),y=c.methods.buy(p,f.from(d),f.from(A),f.from(h),l).send({type:"0x2",from:u,value:p[0]===l?d:void 0}),o&&y.on("transactionHash",(function(t){return o(t,u)})),[2,y]}}))}))}function nt(e,r,o,a){return t(this,void 0,void 0,(function(){var t,u,s,c;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),U("DAI to ".concat(o.symbol)),[4,I(r,o,{chainId:t})];case 2:return(u=n.sent())?(s=u.outputAmount,E(r.currency.symbol,s.toSignificant(6)),c=u.minimumAmountOut(a),E("".concat(o.symbol," min"),c.toSignificant(6)),F("DAI to ".concat(o.symbol)),[2,{amount:s,minAmount:c,route:u.route.path,trade:u}]):(E("Trade",null),F("DAI to ".concat(o.symbol)),[2,null])}}))}))}function et(e,r,o){return t(this,void 0,void 0,(function(){var t,a;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),U("DAI to ".concat(o.currency.symbol)),[4,C(r,o,{chainId:t})];case 2:return(a=n.sent())?(E(r.symbol,a.inputAmount.toSignificant(6)),F("DAI to ".concat(o.currency.symbol)),[2,a.inputAmount]):(E("Trade",null),F("DAI to ".concat(o.currency.symbol)),[2,null])}}))}))}function rt(e,r,o,a){return t(this,void 0,void 0,(function(){var t,u,s,c;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),U("G$ to ".concat(o.symbol)),[4,I(r,o,{chainId:t})];case 2:return(u=n.sent())?(s=u.outputAmount,E(o.symbol,s.toSignificant(6)),c=u.minimumAmountOut(a),E("".concat(o.symbol," min"),c.toSignificant(6)),F("G$ to ".concat(o.symbol)),[2,{amount:s,minAmount:c,route:u.route.path,trade:u}]):(E("Trade",null),F("G$ to ".concat(o.symbol)),[2,null])}}))}))}function ot(e,r,o){return t(this,void 0,void 0,(function(){var t,a;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return t=n.sent(),U("G$ to ".concat(o.currency.symbol)),[4,C(r,o,{chainId:t})];case 2:return(a=n.sent())?(E(o.currency.symbol,a.inputAmount.toSignificant(6)),F("G$ to ".concat(o.currency.symbol)),[2,a.inputAmount]):(E("Trade",null),F("G$ to ".concat(o.currency.symbol)),[2,null])}}))}))}function at(t){var n=q(t),e=t.priceImpact.subtract(n),r=t.inputAmount.multiply(n);return E("Price impact",e.toSignificant(6)),E("Liquidity fee",r.toSignificant(6)),{liquidityFee:r,priceImpact:e}}function ut(a,m,l,f){return void 0===f&&(f=.5),t(this,void 0,void 0,(function(){var t,d,h,p,v,I,w,G,g,$,E,R,T,j,x,k,q,C,B,X,L,M,Y,Z,_,z;return n(this,(function(n){switch(n.label){case 0:return[4,D(a)];case 1:return t=n.sent(),[4,S(a)];case 2:return d=n.sent(),U("Get meta ".concat(l," G$ to ").concat(m)),[4,A(t,"G$")];case 3:if(!(h=n.sent()))throw new Error("Unsupported chain ID");return"ETH"!==m?[3,4]:(p=i.onChain(t),[3,7]);case 4:return"FUSE"!==m?[3,5]:(p=c,[3,7]);case 5:return[4,A(t,m)];case 6:p=n.sent(),n.label=7;case 7:if(!p)throw new Error("Unsupported token");return[4,A(t,"DAI")];case 8:return v=n.sent(),I=null,w=null,[4,b(t,l)];case 9:return G=n.sent(),T=null,j=new u(0),x=e.fromRawAmount(h,"0"),k=new u(0),q=e.fromRawAmount(h,"0"),C=y(f),t!==s.FUSE?[3,11]:[4,rt(a,G,p,C)];case 10:return(B=n.sent())?(T=B.trade,Y=at(B.trade),j=Y.priceImpact,x=Y.liquidityFee,g=B.amount,E=B.minAmount,R=B.route,[3,27]):[2,null];case 11:return[4,H(a,G,d)];case 12:return q=n.sent(),X=G.subtract(q),"G$"!==p.symbol?[3,13]:[2,null];case 13:return"cDAI"!==p.symbol?[3,15]:[4,V(a,X,C)];case 14:return Z=n.sent(),g=Z.amount,E=Z.minAmount,I=e.fromRawAmount(v,0),w=E,$=g,R=[r[t]],[3,24];case 15:return"DAI"!==p.symbol?[3,19]:[4,V(a,X,C)];case 16:return _=n.sent(),g=_.amount,w=_.minAmount,$=g,[4,W(a,w)];case 17:return E=I=n.sent(),[4,W(a,g)];case 18:return g=n.sent(),R=[v],[3,24];case 19:return[4,V(a,X,C)];case 20:return w=n.sent().minAmount,[4,W(a,w)];case 21:return I=n.sent(),[4,nt(a,I,p,C)];case 22:return(L=n.sent())?[4,N(a,I.subtract(I.multiply(L.trade.priceImpact)))]:[2,null];case 23:$=n.sent(),T=L.trade,z=at(L.trade),j=z.priceImpact,x=z.liquidityFee,g=L.amount,E=L.minAmount,R=L.route,n.label=24;case 24:return[4,O(a,t)];case 25:return M=n.sent().cDAI,j=o(M.invert(),X,$),[4,P(a,"GDX",d)];case 26:k=n.sent(),n.label=27;case 27:return F("Get meta ".concat(l," G$ to ").concat(m)),[2,{inputAmount:G,outputAmount:g,minimumOutputAmount:E,DAIAmount:I,cDAIAmount:w,GDXAmount:G.lessThan(k)?G:k,priceImpact:j,slippageTolerance:C,contribution:q,liquidityFee:x,liquidityToken:v,route:R,trade:T}]}}))}))}function st(r,o,a,u){return void 0===u&&(u=.5),t(this,void 0,void 0,(function(){var t,m,l,f,d,h,y,b,v;return n(this,(function(n){switch(n.label){case 0:return[4,D(r)];case 1:return t=n.sent(),U("Get meta ".concat(a," ").concat(o," to G$")),[4,A(t,"G$")];case 2:if(!(m=n.sent()))throw new Error("Unsupported chain ID");return"ETH"!==o?[3,3]:(l=i.onChain(t),[3,6]);case 3:return"FUSE"!==o?[3,4]:(l=c,[3,6]);case 4:return[4,A(t,o)];case 5:l=n.sent(),n.label=6;case 6:if(!l)throw new Error("Unsupported token");return[4,A(t,"DAI")];case 7:return f=n.sent(),d=e.fromRawAmount(l,p(a,l.decimals)),t!==s.FUSE?[3,9]:[4,ot(r,m,d)];case 8:return h=n.sent(),[3,20];case 9:return"G$"!==l.symbol?[3,10]:(h=null,[3,20]);case 10:return"cDAI"!==l.symbol?[3,12]:[4,M(r,d,R)];case 11:return v=n.sent().amount,h=v,[3,20];case 12:return"DAI"!==l.symbol?[3,15]:[4,N(r,d)];case 13:return b=n.sent(),[4,M(r,b,R)];case 14:return v=n.sent().amount,h=v,[3,20];case 15:return[4,et(r,f,d)];case 16:return(y=n.sent())?[3,17]:(h=null,[3,20]);case 17:return[4,N(r,y)];case 18:return b=n.sent(),[4,M(r,b,R)];case 19:v=n.sent().amount,h=v,n.label=20;case 20:return F("Get meta ".concat(a," ").concat(o," to G$")),h?[2,ut(r,o,h.toExact(),u)]:[2,null]}}))}))}function ct(e,r,o){return t(this,void 0,void 0,(function(){var t,a,u,c,i,m,d,A;return n(this,(function(n){switch(n.label){case 0:return[4,D(e)];case 1:return n.sent()!==s.FUSE?[3,2]:[2,B(e,r.trade,r.slippageTolerance,o)];case 2:return[4,S(e)];case 3:return t=n.sent(),[4,T(e)];case 4:return a=n.sent(),u=k(r,"sell"),c=u.input,i=u.minReturn,m=u.minDai,d=r.route.map((function(t){return t.address})),A=a.methods.sell(d,f.from(c),f.from(m),f.from(i),l).send({from:t,type:"0x2"}),o&&A.on("transactionHash",(function(n){return o(n,t)})),[2,A]}}))}))}function it(e){return t(this,void 0,void 0,(function(){var t,r;return n(this,(function(n){switch(n.label){case 0:return[4,h(e)];case 1:return t=a.apply(void 0,[n.sent(),1]),r=t[0],[2,Array.from(r.values()).filter((function(t){return t.name&&t.symbol&&!["G$","GDX","GDAO"].includes(t.symbol)}))]}}))}))}function mt(e,r){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return[4,j(e)];case 1:return[4,n.sent().methods.isWhitelisted(r).call()];case 2:return t=n.sent(),E("Wallet whitelisted",t),[2,t]}}))}))}function lt(e,r){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return[4,x(e)];case 1:return[4,n.sent().methods.checkEntitlement().call({from:r})];case 2:return t=n.sent(),E("UBI",t.toString()),[2,t.toString()]}}))}))}function ft(e,r){return t(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,dt(e)];case 1:return t.sent(),[4,x(e)];case 2:return[2,t.sent().methods.claim().send({from:r,gasPrice:"10000000000"})]}}))}))}function dt(e){return t(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,D(e)];case 1:if(t.sent()!==s.FUSE)throw new $(d[s.FUSE]);return[2]}}))}))}export{nt as D,rt as G,Z as a,_ as b,z as c,Q as d,tt as e,et as f,K as g,ot as h,ut as i,st as j,M as k,N as l,W as m,V as n,it as o,mt as p,lt as q,at as r,ct as s,ft as t,Y as x};
